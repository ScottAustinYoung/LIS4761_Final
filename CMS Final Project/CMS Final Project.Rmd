---
title: "CMS Final Project"
author: Christopher Reddish, Khushi Patel, Naomi Vaid, Sneh Patel, Scott Young,  and
  Steven Barden
date: ""
output: html_document
---

## Introduction

```{r, "Libraries"}
# Add your library below.
library(tidyverse)
library(GGally)

```

##Cleaning the dataset: Sneh Patel, Steven Barden, Christopher Reddish
1. Filtering out Florida Data
2. Adding Custom Labels for column (needed)
3. Removing unwanted columns (needed)
```{r, "Step 1"}
## Step 1.1
# Read CSV 
# data <- read.csv("data/OGdataCMS.csv")  

# Filter rows where zipcode is between 32001 and 34999
# filtered_data <- data[data$Rndrng_Prvdr_Zip5 >= 32001 & data$Rndrng_Prvdr_Zip5 <= 34999, ]

# Save the filtered data to a new CSV in the 'data' folder
# write.csv(filtered_data, "data/filtered_data.csv", row.names = FALSE)

# Print confirmation
print(paste("Filtered data saved to: data/filtered_data.csv"))
#"further cleaned the dataset using Excel and corrected some data inconsistencies. This process ensured the removal of any discrepancies and improved the overall accuracy of the data
#Step2.2
#Added Custom Labels for column did using excel.
```

## Association Rule Mining: Christopher Reddish, Scott Young
 
```{r, "Step 2"}

```


## K-Means Clustering: Christopher Reddish, Sneh Patel

```{r, "Step 3"}

# Helper function to clean monetary columns
clean_money <- function(x) {
  as.numeric(gsub("[$,]", "", x))
}

# 1. Load and clean only the necessary columns
df_raw <- read_csv("data/Rendering_Provider.csv", col_types = cols(.default = "c")) %>%
  mutate(
    Total_Services = as.numeric(`Total Services`),
    Avg_Sbmtd_Chrg = clean_money(`Average Submitted Charge`),
    Avg_Pymt_Amt = clean_money(`Average Medicare Payment Amount`)
  ) %>%
  select(
    Total_Services,
    Avg_Sbmtd_Chrg,
    Avg_Pymt_Amt
  ) %>%
  na.omit()

cat("Rows after cleaning:", nrow(df_raw), "\n")
cat("Unique rows:", nrow(unique(df_raw)), "\n")

# 2. Scale the data
df_scaled <- scale(df_raw)

# 3. Determine number of clusters (up to 4)
k <- min(4, nrow(unique(df_scaled)))
if (k < 2) stop("Not enough data to form clusters.")

# 4. Run k-means clustering
set.seed(123)
clusters <- kmeans(df_scaled, centers = k, nstart = 25)

# 5. Add cluster labels to the original data
results <- read_csv("data/Rendering_Provider.csv", col_types = cols(.default = "c")) %>%
  mutate(
    Total_Services = as.numeric(`Total Services`),
    Avg_Sbmtd_Chrg = clean_money(`Average Submitted Charge`),
    Avg_Pymt_Amt = clean_money(`Average Medicare Payment Amount`)
  ) %>%
  select(
    Total_Services,
    Avg_Sbmtd_Chrg,
    Avg_Pymt_Amt
  ) %>%
  na.omit() %>% 
  mutate(Cluster = clusters$cluster)

# 6. Save results
write_csv(results, "provider_clusters.csv")

# 7. Visualize clusters (optional)
ggpairs(
  bind_cols(as_tibble(df_raw), Cluster = factor(clusters$cluster)),
  columns = 1:3,
  aes(color = Cluster)
)

# 8. Calculate summary statistics for each cluster
cluster_summary <- results %>%
    group_by(Cluster) %>%
    summarize(
        count = n(),
        mean_services = mean(Total_Services, na.rm = TRUE),
        median_services = median(Total_Services, na.rm = TRUE),
        mean_submitted_charge = mean(Avg_Sbmtd_Chrg, na.rm = TRUE),
        median_submitted_charge = median(Avg_Sbmtd_Chrg, na.rm = TRUE),
        mean_payment = mean(Avg_Pymt_Amt, na.rm = TRUE),
        median_payment = median(Avg_Pymt_Amt, na.rm = TRUE)
    )

print(cluster_summary)

#Here's a summary of our analysis, based on the provided data and the cluster results:

# We performed K-means clustering on a dataset of healthcare providers to identify distinct groups based on their service volume (Total_Services), average submitted charges (Avg_Sbmtd_Chrg), and average Medicare payment amounts (Avg_Pymt_Amt). 
# This involved cleaning the data to handle currency formatting, scaling the relevant columns, and then running the K-means algorithm to group providers into clusters. Based on this, a summary of the clusters can be performed

# The clustering process revealed four distinct provider groups:

# Cluster 1: These providers exhibit a smaller average number of services (41.43), and are associated with very high average submitted charges (6860.51) and high average payment amounts (1116.04).

# Cluster 2: This is the largest group, with the vast majority of providers, and they have somewhat low average number of services (63.48) and average submitted charges (366.53), resulting in moderate average payment amounts (79.17).

# Cluster 3: The smallest group, this group is associated with a low average number of services (35.48), while incurring incredibly high average submitted charges (40919.94) with a result of very high average payment amounts (8328.96).

# Cluster 4: This cluster has the highest average number of services (515.20), while having low submitted charges (204.16), ultimately leading to low payment amounts (58.04).

# These findings offer actionable insights. Clusters 1 and 3 might warrant further investigation for potentially inflated billing practices due to their high charges despite low service volumes. 
# Conversely, Cluster 4 represents a high-volume, low-cost service model, which could be studied to identify best practices for efficient healthcare delivery. 
# Cluster 2 represents the average provider, based on this dataset. 
# These insights can inform targeted policy interventions, audits, and strategies for improving cost-effectiveness and quality of care within the Medicare system
```


## Linear Regression: Steven Barden, Scott Young
 
```{r, "Step 4"}
df_lm <- read.csv("Data/chris_cleaned_data.csv") #replace once 1.1 is revised with the loaded data so that we have a separate df to as.factor the needed variables.

#Ensuring the Linear Regression model understands that the following variables are categorical and not numeric types.
df_lm$Place_Of_Srvc <- as.factor(df_lm$Place_Of_Srvc)
df_lm$Specialty <- as.factor(df_lm$Specialty)
df_lm$RUCA_Desc <- as.factor(df_lm$RUCA_Desc)

#Creation of the Linear Regression model.
lm_model <- lm(Medicare_Payment ~ Services + Submitted_Charge + Beneficiaries +
                 Place_Of_Srvc + Specialty + RUCA_Desc, data = df_lm)

summary(lm_model)
```
# The linear model uses Services, Submitted_Charge, and Beneficiaries as the numeric predictors.
# The categorical predictors are Place_Of_Srvc, Specialty, and RUCA_Desc.
# The R-squared value of the model is 0.6486, which explains a 65%~ variation in Medicare_Payment.
# The F-statistic & P-values are both quite high, indicating a statistically significant model.
# The average error stands at about $176.
# As the Services increase, the average Medicare_Payment slightly decreases which tells that dense facilities reflect an economy-of-scale factor.
# The strongest predictor is the Submitted_Charge value, in which higher billed values raises Medicare payments, as is obvious.
# Beneficiaries stands as not significant, meaning the amount of people receiving service does not influence costs.
# Place_Of_Srvc0, in an office setting, has a high p-value of $20.20. This stands to reason that smaller facilities are associated with a higher cost.
# In terms of other categorical variables and their effect, Specialty has a range of types in which costs are reduced or increased on average.
## Increases include: Ambulance Service Provider, Oral Surgery, Peripheral Vascular Disease, and Micrographic Dermatologic Surgery.
## Decreases include: CRN and Anesthesiology.
# RUCA_Desc has the following takeaways: Micropolitan areas receive less payment, Secondary flow to large urbanized areas has a higher payment.

## Heat Map Visual: Khushi Patel, Naomi Vaid
 
```{r, "Step 5"}

library(ggplot2)
library(sf)
library(dplyr)
library(readr)

# File paths
medicare_path <- "~/Desktop/medicare_cleaned.csv"
shapefile_path <- "~/Desktop/tl_2010_12_zcta510.shp"

# Load Medicare data
medicare_cleaned <- read_csv(medicare_path) %>%
  mutate(Zip = as.character(Zip))

# Load shapefile
zcta <- st_read(shapefile_path) %>%
  mutate(ZCTA5CE10 = as.character(ZCTA5CE10))

# Choose specialty
selected_specialty <- "Internal Medicine"

# Filter and summarize
filtered_data <- medicare_cleaned %>%
  filter(Specialty == selected_specialty) %>%
  group_by(Zip) %>%
  summarize(
    Avg_Payment = mean(Medicare_Payment, na.rm = TRUE),
    Providers = n(),
    .groups = "drop"
  )

# Merge with shapefile
merged_data <- zcta %>%
  left_join(filtered_data, by = c("ZCTA5CE10" = "Zip"))

# Create heat map
ggplot(data = merged_data) +
  geom_sf(aes(fill = Avg_Payment), color = "white", size = 0.2) +
  scale_fill_viridis_c(
    option = "plasma",
    na.value = "grey90",
    name = "Avg Payment ($)",
    limits = c(0, 150),
    breaks = c(0, 50, 100, 150),
    oob = scales::squish
  ) +
  labs(
    title = "Medicare Average Payment by ZIP Code in Florida",
    subtitle = paste("Specialty:", selected_specialty),
  ) +
  theme_minimal(base_size = 14) +
  theme(
    legend.position = "right",
    plot.title = element_text(face = "bold", size = 16),
    plot.subtitle = element_text(size = 13),
    plot.caption = element_text(size = 10, face = "italic")
  )

# Here is a summary of our analysis based on Medicare payment data visualization:

# We analyzed average Medicare payments for providers specializing in Internal Medicine across Florida ZIP codes. 
# This process began by loading and preparing a cleaned Medicare dataset and a shapefile representing Florida ZIP Code Tabulation Areas (ZCTAs).

# After filtering the data for the selected specialty ("Internal Medicine"), we calculated the average Medicare 
# payment and the number of providers per ZIP code. This summarized dataset was then merged with the shapefile data 
# to enable geographic plotting.

# Using ggplot2 and the sf package, we created a choropleth map showing the distribution of average Medicare payments 
# across Florida. Areas with higher average payments appear in brighter plasma shades, while areas with lower payments 
# or no data are shown in muted tones.

# The heatmap helps reveal regional disparities in Medicare reimbursements, highlighting ZIP codes with notably higher 
# or lower average payments. These visual insights can inform further investigation into geographic trends in healthcare 
# spending, potential inequities in reimbursement rates, or gaps in provider coverage for Internal Medicine in Florida.
```
